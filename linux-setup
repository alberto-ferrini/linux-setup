#!/bin/bash

set -eu

version=1.0.0
base_url=https://raw.githubusercontent.com/alberto-ferrini/linux-setup/refs/heads/main

echo ğŸ”µ Linux Setup $version

echo â³ Checking for update...
# Download the content of the file into a variable
online_content=$(curl -s $base_url/linux-setup)

# Use grep to find the line starting with 'linuxSetupVersion=' and sed to extract the value after '='
online_version=$(echo "$online_content" | grep '^version=' | sed 's/^version=//')

if [ $version = $online_version ]; then
    echo "ğŸŸ¢ Linux Setup is up to date"
else
    echo "ğŸŸ¡ Update is available (v. $online_version)"
    read -p "ğŸ‘‰ Do you want to upgrade now? (y/n) " answer
    if [ $answer = "y" ]; then
        echo "â³ Updating..."
        curl -sL $base_url/linux-setup -o $HOME/linux-setup
        chmod 755 $HOME/linux-setup
        $HOME/linux-setup
    fi
fi

echo
echo "ğŸ“˜ Git"
if ! command -v git &> /dev/null; then
    echo "ğŸŸ¡ Git is not installed"
    read -p "ğŸ‘‰ Do you want to install? (y/n) " answer
    if [ $answer = "y" ]; then
        echo "â³ Installing..."
        sudo apt-get install -y git &> /dev/null
    fi
fi
if command -v git &> /dev/null; then
    git_version=$(git --version | sed 's/.* //')
    echo "ğŸŸ¢ Git installed (v. $git_version)"
    git_store=$(git config --global --get credential.helper || true)
    if [ -z $git_store ]; then
        echo "ğŸŸ¡ Git credential storage not enabled"
        read -p "ğŸ‘‰ Do you want to enable? (y/n) " answer
        if [ $answer = "y" ]; then
            echo "â³ Enabling..."
            git config --global credential.helper store
            echo "ğŸŸ¢ Git credential storage enabled"
        fi
    else
        echo "ğŸŸ¢ Git credential storage enabled"
    fi
fi

echo
echo "ğŸ“˜ Docker"
if ! command -v docker &> /dev/null; then
    echo "ğŸŸ¡ Docker is not installed"
    read -p "ğŸ‘‰ Do you want to install? (y/n) " answer
    if [ $answer = "y" ]; then
        echo "â³ Installing..."
        sudo apt remove -y docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc
        sudo apt install -y ca-certificates
        sudo DEBIAN_FRONTEND=noninteractive apt install -y tzdata
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list
        sudo apt update
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        sudo usermod -aG docker $USER
        sudo systemctl enable docker.service
        sudo systemctl enable containerd.service
        newgrp docker
    fi
fi
if command -v docker &> /dev/null; then
    echo "ğŸŸ¢ Docker installed"
fi
